# üß™ Admin Handoff Testing Guide

## ‡∏´‡∏•‡∏±‡∏á Deploy ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ:

---

## ‚úÖ Test 1: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "admin" ‡πÉ‡∏ô Facebook

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:

1. ‡πÄ‡∏õ‡∏¥‡∏î **Facebook Page Inbox** (Business Suite ‡∏´‡∏£‡∏∑‡∏≠ Pages Manager)
2. ‡∏´‡∏≤‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà bot ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
3. **‡∏à‡∏≤‡∏Å Page account** (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà user) ‡∏û‡∏¥‡∏°‡∏û‡πå: `admin`
4. **Expected Result:**
   - ‚úÖ Bot ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
   - ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö

5. ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏≠‡∏µ‡∏Å (‡πÄ‡∏ä‡πà‡∏ô "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", "‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏´‡∏°")
6. **Expected Result:**
   - ‚úÖ Bot **‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö** (‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
   - ‚úÖ Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ

7. ‡∏£‡∏≠ **1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á** (‡∏´‡∏£‡∏∑‡∏≠ 60+ ‡∏ô‡∏≤‡∏ó‡∏µ)
8. ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
9. **Expected Result:**
   - ‚úÖ Bot **‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏≠‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥** (timeout ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß)

---

## ‚úÖ Test 2: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "/admin" ‡πÉ‡∏ô LINE

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:

1. ‡πÄ‡∏õ‡∏¥‡∏î **LINE Official Account Manager**
2. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Chat
3. ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Admin (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ account ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô `admin_user_ids`
4. ‡∏û‡∏¥‡∏°‡∏û‡πå: `/admin`
5. **Expected Result:**
   - ‚úÖ Bot ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

6. ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
7. **Expected Result:**
   - ‚úÖ Bot ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö (admin mode active)

---

## ‚úÖ Test 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs

```bash
# ‡∏î‡∏π log realtime
gcloud run services logs tail autobot \
  --project=autobot-prod-251215-22549 \
  --region=asia-southeast1

# Filter ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin handoff
gcloud run services logs read autobot \
  --project=autobot-prod-251215-22549 \
  --region=asia-southeast1 \
  --limit=200 \
  | grep -i "ADMIN_HANDOFF"
```

### Log ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≠:

```json
// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå "admin"
[ADMIN_HANDOFF] Manual command detected
[ADMIN_HANDOFF] Updated last_admin_message_at

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á admin active
[ADMIN_HANDOFF] Admin still active - bot paused
{
  "reason": "admin_handoff_active",
  "admin_timeout_remaining_sec": 3540
}

// ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏ö 1 ‡∏ä‡∏°
[ADMIN_HANDOFF] Timeout expired - resuming bot
[ADMIN_HANDOFF] Cleared last_admin_message_at
```

---

## üêõ Troubleshooting

### ‚ùå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Bot ‡∏¢‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÅ‡∏°‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå "admin"

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏ä‡πá‡∏Ñ:**

1. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ deploy ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:**
   ```bash
   gcloud run services describe autobot \
     --region=asia-southeast1 \
     --project=autobot-prod-251215-22549 \
     --format="value(status.latestReadyRevisionName,metadata.annotations.'serving.knative.dev/lastModifierTime')"
   ```

2. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ DB ‡∏°‡∏µ column:**
   ```bash
   gcloud sql connect autobot-db \
     --project=autobot-prod-251215-22549 \
     --database=autobot
   
   # ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ô SQL:
   SHOW COLUMNS FROM chat_sessions LIKE 'last_admin_message_at';
   ```

3. **‡∏î‡∏π log ‡∏ß‡πà‡∏≤‡∏°‡∏µ error:**
   ```bash
   gcloud run services logs read autobot \
     --project=autobot-prod-251215-22549 \
     --region=asia-southeast1 \
     --limit=50 \
     | grep -i error
   ```

---

### ‚ùå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Column ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô DB

**‡πÅ‡∏Å‡πâ:**

```bash
# ‡∏£‡∏±‡∏ô migration manual
gcloud sql connect autobot-db \
  --project=autobot-prod-251215-22549 \
  --database=autobot

# ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ô SQL ‡∏ô‡∏µ‡πâ:
ALTER TABLE chat_sessions 
ADD COLUMN last_admin_message_at TIMESTAMP NULL DEFAULT NULL;

CREATE INDEX idx_admin_timeout ON chat_sessions(last_admin_message_at);
```

---

### ‚ùå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Facebook ‡πÑ‡∏°‡πà detect admin

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** `is_echo` flag ‡∏´‡∏£‡∏∑‡∏≠ `sender_id === page_id` ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

**‡πÅ‡∏Å‡πâ:**

‡πÑ‡∏õ‡∏ó‡∏µ‡πà `api/webhooks/facebook.php` ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ:

```php
// ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì line 130
$isEcho = $messaging['message']['is_echo'] ?? false;
$senderId = $messaging['sender']['id'] ?? null;
$pageId = $config['page_id'] ?? null;

if ($isEcho || $senderId === $pageId) {
    $isAdmin = true;
    Logger::info('[FACEBOOK_WEBHOOK] Admin detected', [
        'is_echo' => $isEcho,
        'sender_equals_page' => $senderId === $pageId
    ]);
}
```

---

## üìä Expected Metrics

‡∏´‡∏•‡∏±‡∏á deploy ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:

- ‚úÖ Log ‡∏à‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° `[ADMIN_HANDOFF]` ‡∏õ‡∏£‡∏≤‡∏Å‡∏è
- ‚úÖ `chat_sessions.last_admin_message_at` ‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠ admin ‡∏û‡∏¥‡∏°‡∏û‡πå
- ‚úÖ Bot ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á reply ‡πÄ‡∏°‡∏∑‡πà‡∏≠ `last_admin_message_at` ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ä‡∏°
- ‚úÖ Gateway response ‡∏à‡∏∞‡∏°‡∏µ `"reason": "admin_handoff_active"`

---

## üéØ Success Criteria

**‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠:**

1. ‚úÖ Admin ‡∏û‡∏¥‡∏°‡∏û‡πå "admin" ‚Üí Bot ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
2. ‚úÖ User ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏Å‡πá‡πÑ‡∏°‡πà‡∏°‡∏µ reply (‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1 ‡∏ä‡∏°)
3. ‚úÖ Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô bot ‡πÑ‡∏î‡πâ
4. ‚úÖ ‡∏´‡∏•‡∏±‡∏á 1 ‡∏ä‡∏° bot ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
5. ‚úÖ Log ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° `[ADMIN_HANDOFF]` ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å step

---

Last updated: 2025-12-27

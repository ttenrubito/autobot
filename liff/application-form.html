<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£ - Autobot</title>
    
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .profile-section {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
            display: none; /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î LIFF ‡πÄ‡∏™‡∏£‡πá‡∏à */
        }
        
        .profile-section.show {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .profile-pic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .profile-info h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .profile-info p {
            font-size: 14px;
            color: #666;
        }
        
        .form-section {
            padding: 30px 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group label .required {
            color: #dc3545;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-group .hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .form-group .error {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }
        
        .form-group.has-error input,
        .form-group.has-error select,
        .form-group.has-error textarea {
            border-color: #dc3545;
        }
        
        .form-group.has-error .error {
            display: block;
        }
        
        .file-upload {
            position: relative;
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .file-upload-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        
        .file-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .file-preview.show {
            display: block;
        }
        
        .file-preview img {
            max-width: 100%;
            border-radius: 8px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message,
        .error-message {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .success-message.show {
            display: block;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h1>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
        </div>
        
        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
        
        <!-- Profile Section (Hidden until LIFF loads) -->
        <div class="profile-section" id="profileSection">
            <img id="profilePic" src="" alt="Profile" class="profile-pic">
            <div class="profile-info">
                <h3 id="profileName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
                <p id="campaignName">‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç: -</p>
            </div>
        </div>
        
        <!-- Form Section -->
        <div class="form-section" id="formSection" style="display: none;">
            <!-- Success/Error Messages -->
            <div class="success-message" id="successMessage">
                ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
            </div>
            
            <div class="error-message" id="errorMessage">
                ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            </div>
            
            <!-- Form -->
            <form id="applicationForm">
                <!-- Dynamic Form Fields (loaded from campaign config) -->
                <h3 style="margin-bottom: 20px; color: #333;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                
                <!-- Container for dynamic fields -->
                <div id="dynamicFormFields">
                    <!-- Default fields (will be replaced if campaign has form_config) -->
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠ <span class="required">*</span></label>
                        <input type="text" id="firstName" name="firstName" required>
                        <div class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠</div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
                        <input type="text" id="lastName" name="lastName" required>
                        <div class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="required">*</span></label>
                        <input type="tel" id="phone" name="phone" pattern="[0-9]{10}" required>
                        <div class="hint">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0812345678 (10 ‡∏´‡∏•‡∏±‡∏Å)</div>
                        <div class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å</div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• <span class="required">*</span></label>
                        <input type="email" id="email" name="email" required>
                        <div class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà <span class="required">*</span></label>
                        <textarea id="address" name="address" required></textarea>
                        <div class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
                    </div>
                </div>
                
                <!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (Dynamic from campaign config) -->
                <h3 style="margin: 30px 0 20px; color: #333;">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</h3>
                <div id="documentFields">
                    <!-- Dynamic document fields will be inserted here -->
                </div>
                
                <!-- Hidden Fields -->
                <input type="hidden" id="lineUserId" name="lineUserId">
                <input type="hidden" id="campaignCode" name="campaignCode">
                
                <!-- Submit Button -->
                <button type="submit" class="submit-btn" id="submitBtn">
                    ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </form>
        </div>
    </div>
    
    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        let liffId = null;
        let lineUserId = null;
        let campaignCode = null;
        let campaignId = null;  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö campaign ID
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
        window.addEventListener('load', async function() {
            console.log('üöÄ LIFF Application Starting...');
            console.log('üåê Current URL:', window.location.href);
            console.log('üìç Pathname:', window.location.pathname);
            console.log('üîç Search:', window.location.search);
            console.log('#Ô∏è‚É£ Hash:', window.location.hash);
            
            // ‡∏î‡∏∂‡∏á campaign code ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á
            let campaignFromUrl = null;
            
            // Parse URL params
            const urlParams = new URLSearchParams(window.location.search);
            console.log('üìã All URL Params:', Array.from(urlParams.entries()));
            
            // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏•‡∏≠‡∏á liff.state (LIFF ‡πÅ‡∏õ‡∏•‡∏á query param ‡πÉ‡∏´‡πâ)
            const liffState = urlParams.get('liff.state');
            console.log('üîó Raw liff.state:', liffState);
            
            if (liffState) {
                // liff.state = "?campaign=DEMO2026" (URL encoded)
                const decodedState = decodeURIComponent(liffState);
                console.log('üîì Decoded liff.state:', decodedState);
                
                // Parse state params
                const stateParams = new URLSearchParams(decodedState);
                console.log('üìã State Params:', Array.from(stateParams.entries()));
                
                campaignFromUrl = stateParams.get('campaign');
                if (campaignFromUrl) {
                    console.log('‚úÖ Found campaign in liff.state:', campaignFromUrl);
                } else {
                    console.warn('‚ö†Ô∏è No campaign in liff.state');
                }
            }
            
            // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏•‡∏≠‡∏á fragment (#campaign=XXX)
            if (!campaignFromUrl) {
                const hash = window.location.hash.substring(1);
                console.log('üîó Hash (without #):', hash);
                
                if (hash) {
                    const hashParams = new URLSearchParams(hash);
                    console.log('üìã Hash Params:', Array.from(hashParams.entries()));
                    
                    campaignFromUrl = hashParams.get('campaign');
                    if (campaignFromUrl) {
                        console.log('‚úÖ Found campaign in fragment:', campaignFromUrl);
                    }
                }
            }
            
            // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏•‡∏≠‡∏á query params (?campaign=XXX)
            if (!campaignFromUrl) {
                campaignFromUrl = urlParams.get('campaign');
                if (campaignFromUrl) {
                    console.log('‚úÖ Found campaign in query:', campaignFromUrl);
                }
            }
            
            // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 4: ‡∏•‡∏≠‡∏á localStorage
            const storedCampaign = localStorage.getItem('liff_campaign_code');
            console.log('üíæ LocalStorage campaign:', storedCampaign);
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ campaign ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage
            if (campaignFromUrl) {
                console.log('üíæ Saving to localStorage:', campaignFromUrl);
                localStorage.setItem('liff_campaign_code', campaignFromUrl);
                campaignCode = campaignFromUrl;
            } else if (storedCampaign) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage (‡∏Å‡∏£‡∏ì‡∏µ redirect ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤)
                console.log('üì¶ Using from localStorage:', storedCampaign);
                campaignCode = storedCampaign;
            } else {
                campaignCode = 'DEMO2026';
                console.log('üîß Using default:', campaignCode);
            }
            
            console.log('‚úÖ Final Campaign Code:', campaignCode);
            
            try {
                // 1. ‡∏î‡∏∂‡∏á Campaign Data ‡∏à‡∏≤‡∏Å API (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ LIFF ID ‡πÅ‡∏•‡∏∞ form_config)
                console.log('üì° Fetching campaign data...');
                const campaignData = await fetchCampaignData();
                console.log('‚úÖ Campaign data loaded:', campaignData);
                
                if (!campaignData) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç');
                }
                
                if (!campaignData.liff_id) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Admin');
                }
                
                liffId = campaignData.liff_id;
                console.log('‚úÖ LIFF ID:', liffId);
                
                // ‡πÄ‡∏Å‡πá‡∏ö campaign ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ API
                campaignId = campaignData.id;
                console.log('‚úÖ Campaign ID:', campaignId);
                
                // 2. Initialize LIFF ‡∏î‡πâ‡∏ß‡∏¢ LIFF ID ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                await initializeLIFF(liffId, campaignData);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                // Show error
                showError(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        });
        
        // Fetch campaign data from API
        async function fetchCampaignData() {
            try {
                const url = `https://autobot.boxdesign.in.th/api/lineapp/campaigns.php?code=${encodeURIComponent(campaignCode)}`;
                console.log('üåê Fetching from:', url);
                
                const response = await fetch(url);
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('üì¶ API Response:', result);
                
                if (result.success && result.data) {
                    return result.data;
                } else {
                    throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç');
                }
            } catch (error) {
                console.error('‚ùå Fetch Error:', error);
                throw error;
            }
        }
        
        // Initialize LIFF
        async function initializeLIFF(liffIdFromDB, campaignData) {
            try {
                console.log('üîß Initializing LIFF with ID:', liffIdFromDB);
                
                // Initialize LIFF with the LIFF ID from database
                await liff.init({ liffId: liffIdFromDB });
                
                console.log('‚úÖ LIFF Initialized');
                
                // Check if logged in
                if (!liff.isLoggedIn()) {
                    console.log('Not logged in, redirecting to login...');
                    liff.login();
                    return;
                }
                
                // Get user profile
                const profile = await liff.getProfile();
                console.log('üë§ User Profile:', profile);
                
                lineUserId = profile.userId;
                
                // Show profile
                showProfile(profile, campaignData);
                
                // Build dynamic form from campaign's form_config
                if (campaignData.form_config && campaignData.form_config.length > 0) {
                    buildDynamicForm(campaignData.form_config);
                } else {
                    console.warn('‚ö†Ô∏è No form_config found, using default form');
                }
                
                // Build dynamic document fields from campaign's required_documents
                if (campaignData.required_documents && campaignData.required_documents.length > 0) {
                    renderDocumentFields(campaignData.required_documents);
                } else {
                    console.warn('‚ö†Ô∏è No required_documents found');
                }
                
                // Hide loading, show form
                document.getElementById('loading').style.display = 'none';
                document.getElementById('formSection').style.display = 'block';
                
                // Pre-fill hidden fields
                document.getElementById('lineUserId').value = lineUserId;
                document.getElementById('campaignCode').value = campaignCode;
                
            } catch (error) {
                console.error('LIFF Init Error:', error);
                throw error;
            }
        }
        
        // Show user profile
        function showProfile(profile, campaignData) {
            document.getElementById('profilePic').src = profile.pictureUrl || 'https://via.placeholder.com/60';
            document.getElementById('profileName').textContent = profile.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ LINE';
            document.getElementById('campaignName').textContent = campaignData.name || campaignCode;
            document.getElementById('profileSection').classList.add('show');
        }
        
        // Build dynamic form from campaign form_config
        function buildDynamicForm(formConfig) {
            console.log('üé® Building dynamic form with', formConfig.length, 'questions');
            console.log('üìã Form Config:', formConfig);
            
            const container = document.getElementById('dynamicFormFields');
            if (!container) {
                console.error('‚ùå Dynamic form container not found');
                return;
            }
            
            console.log('‚úÖ Container found, clearing existing fields...');
            
            // Clear existing fields (except hidden ones)
            container.innerHTML = '';
            
            // Build each field
            formConfig.forEach((field, index) => {
                console.log(`üìù Building field ${index + 1}:`, field);
                const fieldHtml = buildFormField(field, index);
                console.log(`‚ú® Generated HTML:`, fieldHtml.substring(0, 100) + '...');
                container.insertAdjacentHTML('beforeend', fieldHtml);
            });
            
            console.log('‚úÖ Dynamic form built successfully - Total fields:', formConfig.length);
        }
        
        // Build individual form field HTML
        function buildFormField(field, index) {
            const fieldId = `field_${index}`;
            const requiredAttr = field.required ? 'required' : '';
            const requiredLabel = field.required ? '<span class="required">*</span>' : '';
            
            let inputHtml = '';
            
            switch (field.type) {
                case 'text':
                case 'email':
                case 'tel':
                case 'number':
                    inputHtml = `<input type="${field.type}" id="${fieldId}" name="${field.label}" 
                                       placeholder="${field.placeholder || ''}" ${requiredAttr}>`;
                    break;
                    
                case 'textarea':
                    inputHtml = `<textarea id="${fieldId}" name="${field.label}" 
                                          rows="4" placeholder="${field.placeholder || ''}" ${requiredAttr}></textarea>`;
                    break;
                    
                case 'date':
                    inputHtml = `<input type="date" id="${fieldId}" name="${field.label}" ${requiredAttr}>`;
                    break;
                    
                case 'select':
                    const options = field.options || [];
                    const optionsHtml = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    inputHtml = `<select id="${fieldId}" name="${field.label}" ${requiredAttr}>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                                    ${optionsHtml}
                                </select>`;
                    break;
                    
                default:
                    inputHtml = `<input type="text" id="${fieldId}" name="${field.label}" 
                                       placeholder="${field.placeholder || ''}" ${requiredAttr}>`;
            }
            
            return `
                <div class="form-group">
                    <label>
                        ${field.label} ${requiredLabel}
                    </label>
                    ${inputHtml}
                </div>
            `;
        }
        
        // Render dynamic document fields from campaign required_documents config
        function renderDocumentFields(requiredDocuments) {
            const container = document.getElementById('documentFields');
            
            if (!requiredDocuments || !Array.isArray(requiredDocuments) || requiredDocuments.length === 0) {
                console.log('üìÑ No required documents configured');
                container.innerHTML = '<p style="color: #666;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</p>';
                return;
            }
            
            console.log('üìÑ Rendering', requiredDocuments.length, 'document fields');
            
            let html = '';
            
            requiredDocuments.forEach((doc, index) => {
                const docId = doc.type || `doc_${index}`;
                const label = doc.label || '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
                const required = doc.required !== false; // Default to required
                const requiredAttr = required ? 'required' : '';
                const requiredLabel = required ? '<span class="required">*</span>' : '';
                const accept = doc.accept || 'image/*,application/pdf'; // Accept images and PDFs
                
                html += `
                    <div class="form-group">
                        <label>${label} ${requiredLabel}</label>
                        <div class="file-upload">
                            <label for="${docId}" class="file-upload-btn">
                                üì∑ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î${label}
                            </label>
                            <input type="file" 
                                   id="${docId}" 
                                   data-doc-type="${doc.type}"
                                   data-doc-label="${label}"
                                   accept="${accept}"
                                   ${requiredAttr}>
                            <div class="file-preview" id="${docId}_preview" style="display: none;">
                                <img id="${docId}_img" src="" alt="Preview">
                                <span id="${docId}_name" style="display: block; margin-top: 10px; color: #666;"></span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add change event listeners for all file inputs
            requiredDocuments.forEach((doc, index) => {
                const docId = doc.type || `doc_${index}`;
                const fileInput = document.getElementById(docId);
                
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        handleFilePreview(e, docId);
                    });
                }
            });
            
            console.log('‚úÖ Document fields rendered');
        }
        
        // Handle file preview
        function handleFilePreview(event, docId) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById(`${docId}_preview`);
            const img = document.getElementById(`${docId}_img`);
            const nameSpan = document.getElementById(`${docId}_name`);
            
            if (!preview) return;
            
            // Show filename
            if (nameSpan) {
                nameSpan.textContent = `üìé ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            }
            
            // If image, show preview
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (img) {
                        img.src = e.target.result;
                        img.style.display = 'block';
                    }
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                // For PDFs and other files, just show the name
                if (img) {
                    img.style.display = 'none';
                }
                preview.style.display = 'block';
            }
        }
        
        // OLD: Remove hardcoded file preview
        // document.getElementById('idCard').addEventListener('change', function(e) { ... })
        
        // Handle form submission
        document.getElementById('applicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('üì§ Form submit triggered');
            
            // Disable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            try {
                // Get LINE profile for additional data
                const profile = await liff.getProfile();
                console.log('üë§ Getting profile for submission:', profile);
                
                // Collect all form data dynamically
                const formData = {
                    campaign_id: campaignId,
                    line_user_id: profile.userId,
                    line_display_name: profile.displayName,
                    line_picture_url: profile.pictureUrl,
                    line_profile: {
                        userId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl,
                        statusMessage: profile.statusMessage
                    },
                    form_data: {}
                };
                
                console.log('üéØ Campaign ID:', formData.campaign_id);
                console.log('üë§ User ID:', formData.line_user_id);
                console.log('üë§ Display Name:', formData.line_display_name);
                console.log('üñºÔ∏è Picture URL:', formData.line_picture_url);
                
                // Collect dynamic field data
                const formFields = document.querySelectorAll('#dynamicFormFields input, #dynamicFormFields textarea, #dynamicFormFields select');
                console.log('üìã Found', formFields.length, 'form fields');
                
                formFields.forEach((field, index) => {
                    const fieldName = field.name || `field_${index}`;
                    const fieldValue = field.value;
                    formData.form_data[fieldName] = fieldValue;
                    console.log(`  ‚úÖ ${fieldName}: ${fieldValue}`);
                });
                
                // Extract phone and email from form_data if available
                if (formData.form_data['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || formData.form_data['‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || formData.form_data['phone']) {
                    formData.phone = formData.form_data['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || formData.form_data['‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || formData.form_data['phone'];
                }
                if (formData.form_data['‡∏≠‡∏µ‡πÄ‡∏°‡∏•'] || formData.form_data['email'] || formData.form_data['Email']) {
                    formData.email = formData.form_data['‡∏≠‡∏µ‡πÄ‡∏°‡∏•'] || formData.form_data['email'] || formData.form_data['Email'];
                }
                
                console.log('üì¶ Complete form data:', formData);
                console.log('üìã Form data object:', JSON.stringify(formData.form_data, null, 2));
                
                // Send to backend API (Step 1: Create/Update Application)
                const url = 'https://autobot.boxdesign.in.th/api/lineapp/applications.php';
                console.log('üåê Posting to:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ API Response:', result);
                
                // Step 2: Upload documents dynamically (from all file inputs)
                const uploadedFiles = [];
                
                if (result.success && result.data && result.data.application_id) {
                    const fileInputs = document.querySelectorAll('#documentFields input[type="file"]');
                    console.log('üì§ Found', fileInputs.length, 'file inputs to upload');
                    
                    for (const fileInput of fileInputs) {
                        const file = fileInput.files[0];
                        if (file) {
                            const docType = fileInput.dataset.docType || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                            const docLabel = fileInput.dataset.docLabel || '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
                            
                            console.log(`üì§ Uploading: ${docLabel} (${docType})`);
                            
                            try {
                                const uploadResult = await uploadDocument(
                                    result.data.application_id, 
                                    file, 
                                    docType,
                                    docLabel  // CRITICAL: Pass label!
                                );
                                
                                if (uploadResult.success) {
                                    uploadedFiles.push(docLabel);
                                    console.log(`‚úÖ ${docLabel} uploaded successfully`);
                                } else {
                                    console.warn(`‚ö†Ô∏è ${docLabel} upload failed:`, uploadResult.message);
                                }
                            } catch (uploadError) {
                                console.error(`‚ùå ${docLabel} upload error:`, uploadError);
                                // Continue with other uploads
                            }
                        }
                    }
                }
                
                if (result.success) {
                    // Show success message
                    const isUpdate = result.data && result.data.is_update;
                    const filesInfo = uploadedFiles.length > 0 ? `\nüìé ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${uploadedFiles.join(', ')}` : '';
                    const successMsg = isUpdate 
                        ? `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!${filesInfo}\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á`
                        : `‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!${filesInfo}\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á`;
                    
                    document.getElementById('successMessage').textContent = successMsg;
                    showSuccess();
                    
                    // Send message to LINE
                    try {
                        const lineMessage = isUpdate
                            ? `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\nüìã ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${result.data.application_no}\nüéØ ‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç: ${campaignCode}${filesInfo}\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πà‡∏∞`
                            : `‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\nüìã ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${result.data.application_no || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•'}\nüéØ ‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç: ${campaignCode}${filesInfo}\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πà‡∏∞`;
                        
                        await liff.sendMessages([{
                            type: 'text',
                            text: lineMessage
                        }]);
                        console.log('‚úÖ LINE message sent');
                    } catch (msgError) {
                        console.warn('‚ö†Ô∏è Could not send LINE message:', msgError);
                    }
                    
                    // Close LIFF after 3 seconds
                    setTimeout(() => {
                        console.log('üëã Closing LIFF window...');
                        liff.closeWindow();
                    }, 3000);
                    
                } else {
                    throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
                }
                
            } catch (error) {
                console.error('‚ùå Submit Error:', error);
                showError(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        });
        
        // Function to upload document
        async function uploadDocument(applicationId, file, documentType, documentLabel) {
            console.log('üì§ Uploading document:', {
                applicationId,
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                documentType,
                documentLabel  // Log the label
            });
            
            // Convert file to base64
            const base64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            
            console.log('‚úÖ File converted to base64, length:', base64.length);
            
            // Send to API
            const uploadData = {
                application_id: applicationId,
                document_type: documentType,
                document_label: documentLabel || documentType, // CRITICAL: Send label!
                file_name: file.name,
                file_data: base64,
                file_type: file.type
            };
            
            const url = 'https://autobot.boxdesign.in.th/api/lineapp/documents.php';
            console.log('üåê Uploading to:', url);
            console.log('üì¶ Upload data:', { ...uploadData, file_data: '[BASE64_DATA]' });
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(uploadData)
            });
            
            console.log('üì• Upload response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('‚úÖ Upload result:', result);
            
            return result;
        }
        
        // Show success message
        function showSuccess() {
            document.getElementById('successMessage').classList.add('show');
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('applicationForm').style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = '‚ùå ' + message;
            errorMsg.classList.add('show');
            document.getElementById('successMessage').classList.remove('show');
        }
    </script>
</body>
</html>

<VirtualHost *:8080>
    ServerAdmin admin@aiautomation.com
    DocumentRoot /var/www/html/public

    <Directory /var/www/html/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Rewrite rules to prevent /public/ in URLs
        RewriteEngine On
        # Block direct access to /public/ path (redirect to root)
        RewriteCond %{THE_REQUEST} \ /public/
        RewriteRule ^public/(.*)$ /$1 [R=301,L]
    </Directory>

    # Alias for /api to actual api directory (outside public)
    Alias /api /var/www/html/api
    <Directory /var/www/html/api>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Alias for /assets to serve from root assets directory (outside public)
    Alias /assets /var/www/html/assets
    <Directory /var/www/html/assets>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Enable proper MIME types
        <FilesMatch "\.(css|js)$">
            Header set Content-Type "text/css; charset=utf-8" env=css
            Header set Content-Type "application/javascript; charset=utf-8" env=js
        </FilesMatch>
    </Directory>

    # Alias for /liff to serve LIFF (LINE Front-end Framework) applications
    Alias /liff /var/www/html/liff
    <Directory /var/www/html/liff>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Enable proper MIME types for LIFF
        <FilesMatch "\.(html|htm)$">
            Header set Content-Type "text/html; charset=utf-8"
        </FilesMatch>
        <FilesMatch "\.(css)$">
            Header set Content-Type "text/css; charset=utf-8"
        </FilesMatch>
        <FilesMatch "\.(js)$">
            Header set Content-Type "application/javascript; charset=utf-8"
        </FilesMatch>
    </Directory>

    # Serve /images from the public images directory
    Alias /images /var/www/html/public/images
    <Directory /var/www/html/public/images>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # CORS Headers (adjust in production)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-CSRF-Token"

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

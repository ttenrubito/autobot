<?php
// filepath: /opt/lampp/htdocs/autobot/includes/bot/RouterV3LineAppHandler.php

require_once __DIR__ . '/BotHandlerInterface.php';
require_once __DIR__ . '/../Database.php';
require_once __DIR__ . '/../Logger.php';

/**
 * RouterV3LineAppHandler
 * 
 * LINE Application Automation System Handler
 * Manages conversation flow for LINE-based application/registration system
 * 
 * Key Features:
 * - Check application status for LINE user
 * - Guide through multi-step form process
 * - Handle document uploads
 * - Send status updates
 * - Re-upload workflow for incomplete applications
 * 
 * @version 3.0
 * @production-ready
 */
class RouterV3LineAppHandler implements BotHandlerInterface
{
    private $db;
    
    public function __construct()
    {
        $this->db = Database::getInstance()->getPdo();
    }
    
    /**
     * Handle incoming message
     * 
     * @param array $context {
     *   'channel_id' => int,
     *   'external_user_id' => string, // LINE userId
     *   'platform' => string, // 'line'
     *   'message' => array,
     *   'config' => array,
     *   'meta' => array
     * }
     * @return array Response with 'text' or 'messages'
     */
    public function handleMessage(array $context): array
    {
        try {
            Logger::info('[ROUTER_V3_LINEAPP] Start', [
                'channel_id' => $context['channel_id'] ?? null,
                'external_user_id' => $context['external_user_id'] ?? null,
                'platform' => $context['platform'] ?? null
            ]);
            
            $lineUserId = $context['external_user_id'] ?? null;
            $message = $context['message'] ?? [];
            $messageText = $message['text'] ?? '';
            
            if (!$lineUserId) {
                return [
                    'text' => '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
                ];
            }
            
            // Check if user has any active applications
            $stmt = $this->db->prepare("
                SELECT id, application_no, campaign_id, campaign_name, status, substatus
                FROM line_applications
                WHERE line_user_id = ?
                ORDER BY created_at DESC
                LIMIT 1
            ");
            
            $stmt->execute([$lineUserId]);
            $latestApplication = $stmt->fetch(PDO::FETCH_ASSOC);
            
            // If no application exists, show campaign list
            if (!$latestApplication) {
                return $this->showCampaignList($lineUserId);
            }
            
            // Route based on current application status
            $status = $latestApplication['status'];
            
            switch ($status) {
                case 'RECEIVED':
                case 'FORM_INCOMPLETE':
                    return $this->handleFormFlow($latestApplication, $messageText);
                    
                case 'DOC_PENDING':
                    return $this->handleDocumentRequest($latestApplication);
                    
                case 'INCOMPLETE':
                    return $this->handleReuploadFlow($latestApplication, $message);
                    
                case 'OCR_PROCESSING':
                    return [
                        'text' => sprintf(
                            "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚è≥\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: %s\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• OCR\n\n‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞",
                            $latestApplication['application_no']
                        )
                    ];
                    
                case 'NEED_REVIEW':
                    return [
                        'text' => sprintf(
                            "‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö üëÄ\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: %s\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡πà‡∏∞",
                            $latestApplication['application_no']
                        )
                    ];
                    
                case 'APPROVED':
                    return [
                        'text' => sprintf(
                            "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞! üéâ\n\n‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: %s\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡πà‡∏∞",
                            $latestApplication['application_no']
                        )
                    ];
                    
                case 'REJECTED':
                    return [
                        'text' => sprintf(
                            "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ üòî\n\n‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà %s ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤\n\n‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° \"‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà\" ‡∏Ñ‡πà‡∏∞",
                            $latestApplication['application_no']
                        )
                    ];
                    
                default:
                    return $this->showApplicationStatus($latestApplication);
            }
            
        } catch (Exception $e) {
            Logger::error('[ROUTER_V3_LINEAPP] Error', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            
            return [
                'text' => '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏∞'
            ];
        }
    }
    
    /**
     * Show available campaigns for user to apply
     */
    private function showCampaignList(string $lineUserId): array
    {
        $stmt = $this->db->prepare("
            SELECT id, code, name, description
            FROM campaigns
            WHERE is_active = 1
                AND (start_date IS NULL OR start_date <= CURDATE())
                AND (end_date IS NULL OR end_date >= CURDATE())
            ORDER BY created_at DESC
            LIMIT 5
        ");
        
        $stmt->execute();
        $campaigns = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        if (empty($campaigns)) {
            return [
                'text' => '‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á'
            ];
        }
        
        $text = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! üëã\n\n‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ:\n\n";
        
        foreach ($campaigns as $idx => $campaign) {
            $text .= sprintf(
                "%d. %s\n   %s\n\n",
                $idx + 1,
                $campaign['name'],
                $campaign['description'] ?? ''
            );
        }
        
        $text .= "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏∞ üì±";
        
        return ['text' => $text];
    }
    
    /**
     * Handle form filling flow
     */
    private function handleFormFlow(array $application, string $messageText): array
    {
        // This is a simplified version
        // In production, you would track which question user is on
        // and validate their answer before moving to next question
        
        return [
            'text' => sprintf(
                "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡πà‡∏∞\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: %s\n‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç: %s\n\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å Rich Menu ‡∏Ñ‡πà‡∏∞",
                $application['application_no'],
                $application['campaign_name']
            )
        ];
    }
    
    /**
     * Handle document upload request
     */
    private function handleDocumentRequest(array $application): array
    {
        return [
            'text' => sprintf(
                "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡πà‡∏∞ üìÑ\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: %s\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π \"‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£\" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞",
                $application['application_no']
            )
        ];
    }
    
    /**
     * Handle re-upload flow for incomplete applications
     */
    private function handleReuploadFlow(array $application, array $message): array
    {
        $substatus = $application['substatus'] ?? '';
        
        return [
            'text' => sprintf(
                "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏∞ üìÑ\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: %s\n‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: %s\n\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π \"‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°\" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏∞",
                $application['application_no'],
                $substatus ?: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'
            )
        ];
    }
    
    /**
     * Show current application status
     */
    private function showApplicationStatus(array $application): array
    {
        $statusMap = [
            'RECEIVED' => '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß',
            'FORM_INCOMPLETE' => '‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö',
            'DOC_PENDING' => '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
            'OCR_PROCESSING' => '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
            'OCR_DONE' => '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
            'NEED_REVIEW' => '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
            'APPROVED' => '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
            'REJECTED' => '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤',
            'INCOMPLETE' => '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°',
            'EXPIRED' => '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'
        ];
        
        $statusText = $statusMap[$application['status']] ?? $application['status'];
        
        return [
            Logger::error('[ROUTER_V3_LINEAPP] Notification error', [
                'error' => $e->getMessage()
            ]);
            return false;
        }
    }
    
    /**
     * Build notification message based on status
     */
    private function buildNotificationMessage(string $applicationNo, string $status, array $options = []): string
    {
        $templates = [
            'APPROVED' => "üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞!\n\n‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà %s ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡πà‡∏∞",
            
            'REJECTED' => "üòî ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞\n\n‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà %s ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: %s\n\n‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞",
            
            'INCOMPLETE' => "üìÑ ‡∏Ç‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏∞\n\n‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà %s\n\n%s\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π '‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°' ‡∏Ñ‡πà‡∏∞",
            
            'APPOINTMENT' => "üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢\n\n‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà %s\n\n‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤: %s\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: %s\n\n%s\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πà‡∏∞",
        ];
        
        switch ($status) {
            case 'APPROVED':
                return sprintf($templates['APPROVED'], $applicationNo);
                
            case 'REJECTED':
                $reason = $options['reason'] ?? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•';
                return sprintf($templates['REJECTED'], $applicationNo, $reason);
                
            case 'INCOMPLETE':
                $message = $options['message'] ?? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
                return sprintf($templates['INCOMPLETE'], $applicationNo, $message);
                
            case 'APPOINTMENT':
                return sprintf(
                    $templates['APPOINTMENT'],
                    $applicationNo,
                    $options['appointment_date'] ?? '-',
                    $options['appointment_location'] ?? '-',
                    $options['appointment_note'] ?? ''
                );
                
            default:
                return sprintf(
                    "üìã ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: %s\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: %s",
                    $applicationNo,
                    $status
                );
        }
    }
}

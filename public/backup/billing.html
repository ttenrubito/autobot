<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ - AI Automation</title>
    <script>
        // Local XAMPP override - remove this block for Cloud Run deployment
        window.BASE_PATH_OVERRIDE = '/autobot';
    </script>
    <link rel="stylesheet" href="/autobot/assets/css/style.css">
    <link rel="stylesheet" href="/autobot/assets/css/responsive-fixes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" onclick="window.location.href = PAGES.USER_DASHBOARD; return false;" class="sidebar-logo">AI Automate</a>
            <p style="font-size: 0.75rem; color: var(--color-gray);">AI Automation Platform</p>
        </div>

        <div class="sidebar-user">
            <div class="sidebar-user-avatar" id="userAvatar">U</div>
            <div class="sidebar-user-info">
                <div class="sidebar-user-name" id="userName">Loading...</div>
                <div class="sidebar-user-email" id="userEmail"></div>
            </div>
        </div>

        <nav>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item">
                    <a href="#" onclick="window.location.href = PAGES.USER_DASHBOARD; return false;" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" onclick="window.location.href = PAGES.USER_SERVICES; return false;" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">ü§ñ</span>
                        <span>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" onclick="window.location.href = PAGES.USER_USAGE; return false;" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìà</span>
                        <span>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="/autobot/payment.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üí≥</span>
                        <span>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" onclick="window.location.href = PAGES.USER_BILLING; return false;" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon">üìÑ</span>
                        <span>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="# onclick="window.location.href = PAGES.USER_PROFILE; return false;" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üë§</span>
                        <span>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
                    </a>
                </li>
                <li class="sidebar-nav-item" style="margin-top: auto; padding-top: 2rem;">
                    <a href="#" onclick="logout(); return false;" class="sidebar-nav-link"
                        style="color: var(--color-danger);">
                        <span class="sidebar-nav-icon">üö™</span>
                        <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ & ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h1>
            <p class="page-subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <!-- Invoices Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <p class="card-subtitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
                                <th>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner" style="margin: 0 auto;"></div>
                                    <p style="margin-top: 1rem; color: var(--color-gray);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payment History -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="card-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <p class="card-subtitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner" style="margin: 0 auto;"></div>
                                    <p style="margin-top: 1rem; color: var(--color-gray);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="/autobot/assets/js/constants.js"></script>
    <script src="/autobot/assets/js/auth.js"></script>
    <script>
        requireAuth();

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadInvoices();
            await loadTransactions();
        });

        async function loadUserInfo() {
            const userData = getUserData();
            if (userData) {
                document.getElementById('userName').textContent = userData.full_name || userData.email;
                document.getElementById('userEmail').textContent = userData.email;
                const initial = (userData.full_name || userData.email).charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = initial;
            }
        }

        async function loadInvoices() {
            try {
                const response = await apiCall('/billing/invoices');

                if (response && response.success) {
                    displayInvoices(response.data);
                }
            } catch (error) {
                console.error('Failed to load invoices:', error);
                displayInvoicesError();
            }
        }

        function displayInvoices(invoices) {
            const tbody = document.getElementById('invoicesBody');

            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                            <p style="color: var(--color-gray);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';

            invoices.forEach(invoice => {
                const row = document.createElement('tr');

                const statusBadge = invoice.status === 'paid'
                    ? '<span class="badge badge-success">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>'
                    : invoice.status === 'pending'
                        ? '<span class="badge badge-warning">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</span>'
                        : invoice.status === 'failed'
                            ? '<span class="badge badge-danger">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>'
                            : '<span class="badge badge-info">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';

                const billingPeriod = invoice.billing_period_start && invoice.billing_period_end
                    ? `${formatDate(invoice.billing_period_start).split(' ')[0]} - ${formatDate(invoice.billing_period_end).split(' ')[0]}`
                    : '-';

                row.innerHTML = `
                    <td><strong>${invoice.invoice_number}</strong></td>
                    <td>${formatDate(invoice.created_at).split(' ')[0]}</td>
                    <td>${billingPeriod}</td>
                    <td><strong>${formatCurrency(invoice.total)}</strong></td>
                    <td>${statusBadge}</td>
                    <td>${invoice.due_date ? formatDate(invoice.due_date).split(' ')[0] : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewInvoice(${invoice.id})">
                            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function displayInvoicesError() {
            const tbody = document.getElementById('invoicesBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem; color: var(--color-danger);">
                        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
                    </td>
                </tr>
            `;
        }

        async function loadTransactions() {
            try {
                const response = await apiCall('/billing/transactions');

                if (response && response.success) {
                    displayTransactions(response.data);
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
                displayTransactionsError();
            }
        }

        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionsBody');

            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem;">
                            <p style="color: var(--color-gray);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';

            transactions.forEach(tx => {
                const row = document.createElement('tr');

                const statusBadge = tx.status === 'successful'
                    ? '<span class="badge badge-success">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>'
                    : tx.status === 'pending'
                        ? '<span class="badge badge-warning">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>'
                        : '<span class="badge badge-danger">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>';

                const paymentMethod = tx.card_brand && tx.card_last4
                    ? `${tx.card_brand.toUpperCase()} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${tx.card_last4}`
                    : '-';

                row.innerHTML = `
                    <td>${formatDate(tx.created_at)}</td>
                    <td>${tx.invoice_number}</td>
                    <td><strong>${formatCurrency(tx.amount)}</strong></td>
                    <td>${paymentMethod}</td>
                    <td>${statusBadge}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function displayTransactionsError() {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: var(--color-danger);">
                        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
                    </td>
                </tr>
            `;
        }

        async function viewInvoice(invoiceId) {
            showLoading();

            try {
                const response = await apiCall(`/billing/invoices/${invoiceId}`);

                if (response && response.success) {
                    showInvoiceDetails(response.data);
                }
            } catch (error) {
                console.error('Failed to load invoice details:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ', 'error');
            } finally {
                hideLoading();
            }
        }

        function showInvoiceDetails(invoice) {
            const itemsHtml = invoice.items.map(item => `
                <tr>
                    <td>${item.description}</td>
                    <td style="text-align: right;">${item.quantity}</td>
                    <td style="text-align: right;">${formatCurrency(item.unit_price)}</td>
                    <td style="text-align: right;"><strong>${formatCurrency(item.amount)}</strong></td>
                </tr>
            `).join('');

            alert(`‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ ${invoice.invoice_number}\n\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${formatCurrency(invoice.total)}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${invoice.status}\n\n(‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ modal ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ)`);
        }
    </script>
</body>

</html>